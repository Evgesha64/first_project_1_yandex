# Отчёт по проекту М1: Предсказание риска поражения сердца

## Общая информация
**Цель проекта**: Разработать модель машинного обучения для предсказания риска сердечных приступов на основе данных пациентов.

**Датасеты**:
- Train: 8685 строк, 28 колонок
- Test: 966 строк, 27 колонок (без таргета)

---

## Шаг 1: Исследование датасета (EDA)

### 1.1. Загрузка и первичный анализ данных

**Выполнено**:
- Загружены датасеты `heart_train.csv` и `heart_test.csv`
- Проверена структура данных и уникальность идентификаторов

**Выявлено**:
- **Train**: 8685 строк, 28 колонок (включая таргет)
- **Test**: 966 строк, 27 колонок (без таргета)
- Все идентификаторы (`id`) уникальны в обоих датасетах
- Наличие колонки `Unnamed: 0` (проверена позже — совпадает с индексом)

**Список признаков**:
- Антропометрические: `Age`, `BMI`, `Gender`
- Биохимия: `Cholesterol`, `Triglycerides`, `Blood sugar`, `CK-MB`, `Troponin`
- Давление: `Systolic blood pressure`, `Diastolic blood pressure`
- Привычки: `Smoking`, `Alcohol Consumption`, `Exercise Hours Per Week`, `Physical Activity Days Per Week`, `Sedentary Hours Per Day`, `Sleep Hours Per Day`
- Медицинские: `Diabetes`, `Family History`, `Previous Heart Problems`, `Medication Use`, `Stress Level`
- Прочие: `Diet`, `Obesity`, `Income`, `Heart rate`
- Таргет: `Heart Attack Risk (Binary)`

---

### 1.2. Анализ типов данных и пропусков

**Выполнено**:
- Проверены типы данных всех колонок
- Выявлены и проанализированы пропуски
- Проверены дубликаты

**Выявлено**:

**Типы данных**:
- `float64`: 24 колонки (большинство признаков)
- `int64`: 3 колонки (`Unnamed: 0`, `Diet`, `id`)
- `object`: 1 колонка (`Gender`)

**Пропуски**:
- **Train**: 2187 пропусков (2.8% от общего числа значений)
- **Test**: 279 пропусков (3.4% от общего числа значений)
- **Паттерн пропусков**: Все пропуски находятся в одних и тех же 9 колонках:
  - `Diabetes` (243 в train, 31 в test)
  - `Family History` (243 в train, 31 в test)
  - `Smoking` (243 в train, 31 в test)
  - `Obesity` (243 в train, 31 в test)
  - `Alcohol Consumption` (243 в train, 31 в test)
  - `Previous Heart Problems` (243 в train, 31 в test)
  - `Medication Use` (243 в train, 31 в test)
  - `Stress Level` (243 в train, 31 в test)
  - `Physical Activity Days Per Week` (243 в train, 31 в test)
- **Важное наблюдение**: Все пропуски в train находятся в одних и тех же 243 строках (9 пропусков на строку). Это указывает на систематический паттерн отсутствия данных.

**Дубликаты**:
- Полных дубликатов строк не обнаружено (0 в train, 0 в test)

---

### 1.3. Анализ целевого признака

**Выполнено**:
- Проанализировано распределение таргета
- Проверен баланс классов
- Визуализировано распределение

**Выявлено**:

**Таргет**: `Heart Attack Risk (Binary)`
- Тип данных: `float64` (позже преобразован в `int64`)
- Уникальные значения: `0.0` (низкий риск), `1.0` (высокий риск)

**Распределение классов**:
- **Класс 0** (низкий риск): 5672 наблюдения (65.31%)
- **Класс 1** (высокий риск): 3013 наблюдения (34.69%)

**Вывод**: Классы несбалансированы (соотношение ~2:1). Для оценки модели необходимо использовать метрики, учитывающие дисбаланс классов:
- **F1-score** (macro или weighted)
- **ROC-AUC**
- **Precision-Recall AUC**

---

### 1.4. Анализ корреляций и поиск утечек данных

**Выполнено**:
- Вычислены корреляции всех признаков с таргетом
- Проверены корреляции между признаками (мультиколлинеарность)
- Визуализированы топ-15 признаков по корреляции с таргетом

**Выявлено**:

**Корреляции с таргетом** (топ-10 по модулю):
1. `Diet`: 0.044
2. `Systolic blood pressure`: 0.034
3. `Sleep Hours Per Day`: 0.019
4. `Cholesterol`: 0.019
5. `Diabetes`: 0.016
6. `Heart rate`: 0.016
7. `Obesity`: 0.015
8. `Alcohol Consumption`: 0.015
9. `Physical Activity Days Per Week`: 0.013
10. `Triglycerides`: 0.012

**Важные наблюдения**:
- Все корреляции с таргетом **очень низкие** (максимум 0.044)
- Это указывает на сложность задачи и необходимость использования нелинейных моделей (например, CatBoost, Random Forest)
- Прямых утечек данных не обнаружено

**Мультиколлинеарность**:
- Сильных корреляций между признаками (|r| > 0.8) **не обнаружено**
- Это хорошо для моделирования — нет необходимости в удалении признаков из-за мультиколлинеарности

---

### 1.5. Детальный анализ признаков

**Выполнено**:
- Базовая статистика всех числовых признаков
- Анализ выбросов (IQR метод)
- Анализ категориальных признаков
- Визуализация распределений ключевых признаков
- Анализ средних значений признаков по классам таргета

**Выявлено**:

**Особенности распределений**:
- Большинство признаков уже **нормализованы** (диапазон 0-1)
- Это указывает на предварительную обработку данных в источнике

**Выбросы** (IQR метод, |r| > 1.5*IQR):
- `Heart rate`: 2 выброса (0.02%)
- `Smoking`: 820 выбросов (9.44%)
- `Blood sugar`: 2134 выброса (24.57%)
- `CK-MB`: 2134 выброса (24.57%)
- `Troponin`: 2134 выброса (24.57%)

**Важное наблюдение**: `Blood sugar`, `CK-MB`, `Troponin` имеют **высокую концентрацию значений** (большое количество нулей или близких к нулю значений). Это может указывать на:
- Много пациентов с нормальными показателями
- Возможную проблему с качеством данных для этих признаков

**Категориальные признаки**:
- `Gender`: 4 уникальных значения
  - `Male`: 5882 (67.8%)
  - `Female`: 2560 (29.5%)
  - `1.0`: 156 (1.8%) — **аномалия данных**
  - `0.0`: 87 (1.0%) — **аномалия данных**
- **Проблема**: В колонке `Gender` присутствуют неоднородные значения (строки и числа), что требует обработки

**Различия между классами таргета**:
- Различия в средних значениях признаков между классами 0 и 1 **минимальны**
- Наибольшие различия:
  - `Diet`: 1.085 (класс 0) vs 1.005 (класс 1)
  - `Systolic blood pressure`: 0.446 (класс 0) vs 0.458 (класс 1)
  - `Sleep Hours Per Day`: 0.508 (класс 0) vs 0.495 (класс 1)
- Это подтверждает сложность задачи и низкие корреляции

---

## Шаг 2: Предобработка данных

### 2.1. Удаление ненужных колонок

**Выполнено**:
- Проверена колонка `Unnamed: 0`
- Удалена колонка `Unnamed: 0` (совпадает с индексом)

**Результат**:
- Train: (8685, 27) после удаления
- Test: (966, 26) после удаления

---

### 2.2. Обработка пропусков

**Выполнено**:
- Проанализирован паттерн пропусков
- Заполнены пропуски медианой (вычисленной на train)

**Стратегия**:
- Все пропуски находятся в числовых признаках
- Использована медиана для заполнения (устойчива к выбросам)
- Медиана вычислена на train и применена к test (для предотвращения утечки данных)

**Результат**:
- Все пропуски заполнены
- Train: 0 пропусков
- Test: 0 пропусков

---

### 2.3. Преобразование типов и кодирование категориальных признаков

**Выполнено**:
- Преобразован таргет из `float64` в `int64`
- Закодирован признак `Gender`

**Результаты**:

**Таргет**:
- Преобразован в `int64`
- Значения: `0` (низкий риск), `1` (высокий риск)

**Gender**:
- Создан маппинг: `{'Male': 0, 'Female': 1, '1.0': 2, '0.0': 3}`
- Преобразован в числовой тип
- **Примечание**: Значения `'1.0'` и `'0.0'` оставлены как отдельные категории (требует дальнейшего анализа)

**Diet**:
- Уже числовой (`int64`)
- Значения: 0, 1, 2, 3
- Распределение: 0 (2783), 1 (2863), 2 (2796), 3 (243)

**Итоговые типы данных**:
- `float64`: 23 колонки
- `int64`: 4 колонки (таргет, Gender, Diet, id)

---

## Шаг 3: Обучение и оптимизация модели

### Результаты
- Финальная модель: CatBoostClassifier  
  - iterations=1500, learning_rate=0.03, depth=4, l2_leaf_reg=1, class_weights=[1.0, 1.88]
- F1 (validation): 0.7719
- ROC-AUC (validation): 0.9241
- Формат `prediction`: класс 0/1 (совместимо с `test.py`)

### Артефакты
- Пайплайн (препроцессинг + модель) сохраняется в `artifacts/model_pipeline.pkl`
- Скрипты: `train.py` (обучение и сохранение), `infer.py` (инференс и генерация `student_predictions.csv`)

### Совместимость с test.py
- Требуется CSV с колонками `id`, `prediction` и сохранением индекса (`to_csv(..., index=True)`), длина совпадает с тестом.

---

## Выводы и рекомендации

### Ключевые выводы

1. **Качество данных**:
   - Данные в целом качественные (нет дубликатов, пропуски систематические)
   - Большинство признаков уже нормализованы
   - Есть аномалии в `Gender` (смешанные типы данных)

2. **Сложность задачи**:
   - Низкие корреляции с таргетом (максимум 0.044)
   - Минимальные различия между классами
   - Несбалансированные классы (65.3% vs 34.7%)
   - **Рекомендация**: Использовать ансамбли (CatBoost, Random Forest) и метрики для несбалансированных данных

3. **Особенности признаков**:
   - Нет мультиколлинеарности (хорошо для моделирования)
   - Выбросы в `Smoking`, `Blood sugar`, `CK-MB`, `Troponin`
   - Высокая концентрация значений в биохимических маркерах

### Следующие шаги

1. **Создание пайплайна предобработки** (sklearn):
   - Использовать `ColumnTransformer` для разных типов признаков
   - Стандартизация числовых признаков (если необходимо)
   - Сохранение пайплайна для применения на test

2. **Обучение моделей**:
   - CatBoost (основная модель)
   - Random Forest (для сравнения)
   - Настройка гиперпараметров
   - Использование кросс-валидации

3. **Оценка качества**:
   - F1-score (weighted)
   - ROC-AUC
   - Precision-Recall AUC
   - Матрица ошибок

4. **Дополнительная обработка**:
   - Анализ и исправление аномалий в `Gender`
   - Обработка выбросов (если необходимо)
   - Feature engineering (создание новых признаков)

---

## Статистика по выполненной работе

- **Ячеек в ноутбуке**: 32 (12 code, 20 markdown)
- **Выполнено ячеек**: 12
- **Этапов анализа**: 2 (EDA + Предобработка)
- **Подшагов**: 8
- **Визуализаций**: 3

---

*Отчёт составлен на основе анализа, выполненного в `Projekt.ipynb`*
